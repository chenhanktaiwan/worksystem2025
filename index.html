<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. 初始化設定 ---
    const SUPABASE_URL = 'https://wvdfuqvebqolvpwhdelg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2ZGZ1cXZlYnFvbHZwd2hkZWxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMzA0MjksImV4cCI6MjA2NzgwNjQyOX0.0VAgxyaoyeFeNbto9pUchwqQVqvHzCzyC22wXb01OKU';
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 2. 取得頁面元素 ---
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const messageDiv = document.getElementById('message');

    // --- 3. 認證功能函式 ---
    const signUp = async () => { /* ... 省略，同最終修正版 ... */ };
    const signInWithPassword = async () => { /* ... 省略，同最終修正版 ... */ };
    const signInWithGoogle = async () => { /* ... 省略，同最終修正版 ... */ };
    const forgotPassword = async () => { /* ... 省略，同最終修正版 ... */ };
    
    // --- (其餘函式複製) ---
    const F_signUp = async () => {
        messageDiv.innerText = "處理中...";
        const { error } = await _supabase.auth.signUp({ email: emailInput.value, password: passwordInput.value });
        if (error) { messageDiv.innerText = '註冊失敗: ' + error.message; }
        else { messageDiv.innerText = ""; alert('註冊成功！請檢查您的信箱以完成驗證。'); }
    };
    const F_signInWithPassword = async () => {
        messageDiv.innerText = "登入中...";
        const { error } = await _supabase.auth.signInWithPassword({ email: emailInput.value, password: passwordInput.value });
        if (error) { messageDiv.innerText = '登入失敗: ' + error.message; }
    };
    const F_signInWithGoogle = async () => {
        messageDiv.innerText = "";
        const { error } = await _supabase.auth.signInWithOAuth({ provider: 'google' });
        if (error) { messageDiv.innerText = 'Google 登入失敗: ' + error.message; }
    };
    const F_forgotPassword = async () => {
        const email = prompt("請輸入您註冊的電子郵件地址：");
        if (!email) return; 
        const resetUrl = `https://hankchen.cc/reset.html`;
        messageDiv.innerText = "正在發送密碼重設郵件...";
        const { error } = await _supabase.auth.resetPasswordForEmail(email, { redirectTo: resetUrl });
        if (error) { messageDiv.innerText = "錯誤：" + error.message; }
        else { messageDiv.innerText = ""; alert("密碼重設郵件已成功寄出，請檢查您的信箱。"); }
    };

    // --- 4. 事件綁定 ---
    document.getElementById('signin-btn').addEventListener('click', F_signInWithPassword);
    document.getElementById('signup-btn').addEventListener('click', F_signUp);
    document.getElementById('google-btn').addEventListener('click', F_signInWithGoogle);
    document.getElementById('forgot-password-link').addEventListener('click', F_forgotPassword);

    // --- 5. 核心：監聽認證狀態變化 ---
    _supabase.auth.onAuthStateChange((event, session) => {
        // 如果偵測到使用者成功登入 (SIGNED_IN)
        if (event === 'SIGNED_IN') {
            // 立刻跳轉到 dashboard.html
            window.location.href = '/dashboard.html';
        }
    });

    // 檢查使用者是否已經是登入狀態，如果是，直接跳轉
    const checkExistingSession = async () => {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session && session.user) {
            window.location.href = '/dashboard.html';
        }
    };

    checkExistingSession();
});
</script>
